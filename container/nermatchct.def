Bootstrap: docker
From: ubuntu:20.04

%environment
    # PATHS
    export PATH=/opt/miniconda3/bin:$PATH
    . /opt/miniconda3/etc/profile.d/conda.sh
    conda activate matchct_env

%files
    container/nerworkflow.yml /opt/environment.yml

%post
    # bind paths
    mkdir -p /aloy
    mkdir -p /aloy/home
    mkdir -p /aloy/data
    mkdir -p /aloy/scratch
    
    # update apt
    apt update -y

    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata
    apt install -y build-essential  \
                   gcc \
                   graphviz \
                   cmake \
                   git \
                   wget \
                   curl \
                   vim \
                   bzip2 \
                   libbz2-dev \
                   file \
                   libxrender-dev \
                   libxext-dev \
                   postgresql \
                   postgresql-contrib \
                   swig \
                   python3-dev \
                   libnetcdf-dev

    apt install -y make git libpopt0 libpopt-dev g++
    apt install -y libnss3 libatk-bridge2.0-0 libcups2 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libxkbcommon0 libpango-1.0-0 libcairo2 libasound2
    
    DEBIAN_FRONTEND=noninteractive apt install -y ttf-mscorefonts-installer
	
    # conda
    mkdir -p /opt/miniconda3
    cd /opt/miniconda3 
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -p /opt/miniconda3 -b -f
    rm Miniconda3-latest-Linux-x86_64.sh
    export PATH=/opt/miniconda3/bin:$PATH
    export MAMBA_NO_LOW_SPEED_LIMIT=1  
    export PIPENV_INSTALL_TIMEOUT=3600  
    export PIP_DEFAULT_TIMEOUT=3600

    # create and activate conda
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
    conda update conda -y
    . /opt/miniconda3/etc/profile.d/conda.sh

    # using mamba for speedup
    conda install -q -y -n base -c conda-forge mamba
    conda config --add channels conda-forge
    mamba update -q -n base mamba
    
    conda env create --name matchct_env --file=/opt/environment.yml
    conda activate matchct_env
    kaleido_get_chrome
